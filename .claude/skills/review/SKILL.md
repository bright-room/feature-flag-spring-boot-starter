---
name: review
description: Perform a thorough code review on the current branch's changes and output a structured Markdown report. Use when reviewing code changes before creating a PR or when asked to review code.
disable-model-invocation: true
argument-hint: "[base-branch (default: main)]"
---

# Code Review Skill

現在のブランチの変更に対する徹底的なコードレビューを実施し、構造化されたMarkdownレポートとして出力すること。

## レビュー方針

- 行番号と**文脈情報（背景知識など）**を必ず含める
- レビュー結果はチームメンバーに共有されるため、細部まで入念に確認すること
- 書き始める前に深く考察し、すべての箇所を漏れなくチェックすること
- 事実に基づかない内容（ハルシネーション）を含めないこと

## 手順

### 1. レビュー対象の特定

ベースブランチ（デフォルト: `main`、引数で指定可能: `$ARGUMENTS`）と現在のブランチの差分を取得してレビュー対象を特定する。

```bash
# ベースブランチの決定
BASE_BRANCH="${ARGUMENTS:-main}"

# 差分のあるファイル一覧
git diff ${BASE_BRANCH}...HEAD --name-only

# 差分の内容
git diff ${BASE_BRANCH}...HEAD

# コミット履歴
git log ${BASE_BRANCH}...HEAD --oneline
```

### 2. コードの読解

差分のあるファイルをすべて読み込み、変更内容を深く理解する。変更されたファイルだけでなく、関連するファイル（呼び出し元、インターフェース、設定ファイルなど）も確認すること。

### 3. レビューの実施

以下の観点でレビューを行う:

- **アーキテクチャ**: 設計パターン、モジュール分割、依存関係の適切さ
- **プロダクトコード**: ロジックの正確性、エッジケース、命名規則、コーディング規約への準拠
- **テストコード**: テストカバレッジ、テストケースの網羅性、テストの品質
- **ビルド・設定**: Gradle設定、Spring Boot設定、Auto-configuration の正確性

### 4. レビュー結果の出力

実行環境に応じて出力先を切り替える。環境変数 `CI` の有無で判定すること。

#### ローカル実行時 (`CI` が未設定)

レビュー結果を `.claude/outputs/reviews/` ディレクトリにファイルとして出力する。

- ディレクトリが存在しない場合は作成すること
- ファイル名: `REVIEW-<現在のブランチ名（スラッシュをハイフンに変換）>.md`
  - 例: ブランチ `feature/add-flux-module` → `REVIEW-feature-add-flux-module.md`

#### GitHub Actions 実行時 (`CI=true`)

レビュー結果を GitHub Pull Request Review として投稿する。人間がレビューするのと同じように、**サマリはレビュー本文**に、**各指摘はコードの該当行にインラインコメント**として紐付ける。

##### 事前準備

```bash
# リポジトリ情報の取得
OWNER=$(gh repo view --json owner -q .owner.login)
REPO=$(gh repo view --json name -q .name)
PR_NUMBER=$(gh pr view --json number -q .number)
LATEST_COMMIT=$(gh pr view --json headRefOid -q .headRefOid)
```

- `PR_NUMBER` が取得できない場合はエラーメッセージを出力して終了すること

##### レビューの構成

レビューは **1回の API コール** で投稿する。以下の2つの要素で構成される:

1. **レビュー本文 (`body`)**: 総合評価 + レビューサマリ（指摘事項一覧表 + 対応チェックリスト）+ カバレッジマトリクス
2. **インラインコメント (`comments`)**: 各指摘を該当ファイル・該当行に紐付け

##### インラインコメントのフォーマット

各指摘を以下の形式でインラインコメントとして記述する:

```
🔴 **C-1: <問題のタイトル>**

**問題点**
<具体的な問題の説明>

**背景**
<なぜこれが問題なのか、技術的な文脈情報>

**修正案**
\```java
// 修正後のコード例
\```
```

- 1つの指摘に関連する修正詳細（C-1-1, C-1-2 等）がある場合は、同じインラインコメント内にまとめて記述すること
- 優先度に応じた絵文字プレフィックスを付けること: 🔴 Critical / 🟠 High / 🟡 Medium / 🟢 Low

##### API コール

`gh api` を使用して PR Review を作成する。コメントの `path` はリポジトリルートからの相対パス、`line` は PR の diff における行番号を指定する。

```bash
gh api repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}/reviews \
  --method POST \
  -f commit_id="${LATEST_COMMIT}" \
  -f body="<レビュー本文のMarkdown>" \
  -f event="COMMENT" \
  --jsonpath-input <(echo '{
    "comments": [
      {
        "path": "src/main/java/com/example/Foo.java",
        "line": 42,
        "body": "🔴 **C-1: 問題のタイトル**\n\n**問題点**\n説明...\n\n**背景**\n文脈...\n\n**修正案**\n```java\n// code\n```"
      },
      {
        "path": "src/test/java/com/example/FooTest.java",
        "line": 10,
        "body": "🟡 **M-1: 問題のタイトル**\n\n**問題点**\n説明..."
      }
    ]
  }')
```

##### 行番号の特定方法

インラインコメントの `line` は **diff のヘッダーから計算した変更後ファイルの行番号** を使用する。

1. `git diff ${BASE_BRANCH}...HEAD` の出力から、各ファイルの diff ヘッダー (`@@ -a,b +c,d @@`) を確認する
2. 指摘対象のコードが変更後ファイルの何行目にあるかを特定する
3. その行番号を `line` フィールドに設定する

**重要**: `line` には diff 上の位置 (position) ではなく、変更後ファイルの実際の行番号を指定すること。また、指摘対象の行が diff に含まれている（追加行 or 変更行）必要がある。diff に含まれない行（未変更行）にはコメントできないため、その場合はレビュー本文に記載すること。

##### 注意事項

- レビュー本文にはインラインコメントで投稿する個別指摘の詳細を重複して書かないこと。サマリの一覧表で項番・タイトル・概要のみ記載する
- diff に含まれない行への指摘がある場合は、レビュー本文の末尾に「その他の指摘」セクションとして記載すること
- API コールが失敗した場合はエラー内容を出力すること

## レビュー結果のフォーマット

以下のフォーマットに従ってMarkdownファイルを生成する。

````markdown
# Code Review: <ブランチ名>

> レビュー日: YYYY-MM-DD
> ベースブランチ: `<base-branch>`
> 対象ブランチ: `<current-branch>`
> レビュー対象コミット: <コミットハッシュ一覧>

## 目次

- [総合評価](#総合評価)
- [レビューサマリ](#レビューサマリ)
- [アーキテクチャレビュー](#アーキテクチャレビュー)
- [プロダクトコードレビュー](#プロダクトコードレビュー)
- [テストコードレビュー](#テストコードレビュー)
- [ビルド・設定レビュー](#ビルド設定レビュー)

---

## 総合評価

<!-- 全体の評価を簡潔に記述 -->

| 観点 | 評価 |
|------|------|
| アーキテクチャ | ⭐⭐⭐⭐☆ |
| コード品質 | ⭐⭐⭐⭐☆ |
| テスト品質 | ⭐⭐⭐☆☆ |
| ビルド・設定 | ⭐⭐⭐⭐☆ |

---

## レビューサマリ

<!-- 対応優先度順の一覧。チェックボックスで解決済みをマークできるようにする -->

### 指摘事項一覧

| # | 優先度 | カテゴリ | タイトル | 概要 |
|---|--------|----------|----------|------|
| C-1 | 🔴 Critical | アーキテクチャ | <タイトル> | <概要> |
| H-1 | 🟠 High | プロダクトコード | <タイトル> | <概要> |
| M-1 | 🟡 Medium | テストコード | <タイトル> | <概要> |
| L-1 | 🟢 Low | ビルド・設定 | <タイトル> | <概要> |

### 対応チェックリスト

- [ ] C-1: <タイトル>
- [ ] H-1: <タイトル>
- [ ] M-1: <タイトル>
- [ ] L-1: <タイトル>

---

## アーキテクチャレビュー

### 🔴 Critical

#### C-1: <問題のタイトル>

**問題点**

<!-- 具体的な問題の説明 -->

> 📍 [`path/to/file.java:42`](path/to/file.java#L42)
> ```java
> // 該当コードの引用
> ```

**背景**

<!-- なぜこれが問題なのか、技術的な文脈情報 -->

**修正案**

```java
// 修正後のコード例
```

---

##### C-1-1: <関連する修正すべき詳細>

<!-- 詳細な説明 -->

> 📍 [`path/to/file.java:55`](path/to/file.java#L55)

---

### 🟠 High

#### H-1: <問題のタイトル>

<!-- 同じフォーマットで記述 -->

### 🟡 Medium

#### M-1: <問題のタイトル>

<!-- 同じフォーマットで記述 -->

### 🟢 Low

#### L-1: <問題のタイトル>

<!-- 同じフォーマットで記述 -->

---

## プロダクトコードレビュー

<!-- アーキテクチャレビューと同じ優先度別フォーマット -->

### 🔴 Critical
### 🟠 High
### 🟡 Medium
### 🟢 Low

---

## テストコードレビュー

<!-- アーキテクチャレビューと同じ優先度別フォーマット -->

### 🔴 Critical
### 🟠 High
### 🟡 Medium
### 🟢 Low

### カバレッジマトリクス

<!-- テスト対象のクラス/メソッドに対するテストカバレッジの概要 -->

| 対象クラス | メソッド/機能 | ユニットテスト | 統合テスト | 備考 |
|-----------|-------------|:-------------:|:---------:|------|
| `ClassName` | `methodName()` | ✅ | ✅ | |
| `ClassName` | `methodName2()` | ✅ | ❌ | テスト未作成 |
| `ClassName` | エッジケース: null入力 | ❌ | ❌ | 要追加 |

---

## ビルド・設定レビュー

<!-- アーキテクチャレビューと同じ優先度別フォーマット -->

### 🔴 Critical
### 🟠 High
### 🟡 Medium
### 🟢 Low
````

## 注意事項

- 指摘がない優先度セクションは「指摘なし」と記載してスキップすること
- 指摘がないカテゴリセクション（例: アーキテクチャレビューに指摘がない場合）も「指摘なし」と記載すること
- 項番は各カテゴリセクション内で通し番号にすること（例: アーキテクチャの Critical は C-1, プロダクトコードの Critical は別途 C-1 から開始）
  - 各カテゴリを識別するため、サマリの一覧表ではカテゴリ列を活用すること
- コード参照は相対パスで記載し、行番号を含めること
- 推測ではなく、実際にコードを読んで確認した事実のみを記載すること
- 良い点（Good practices）があれば、各セクションの冒頭で簡潔に言及すること
